trigger:
- master

pool: Naveen-LinuxVM

variables:
  projectRoot: $(System.DefaultWorkingDirectory)
  deployRoot: /home/320273321/deploy/flaskapp

stages:
- stage: Build
  displayName: Build stage
  jobs:
  - job: BuildJob
    pool: Naveen-LinuxVM
    steps:



    - script: |
        set -euo pipefail
        cd "$(projectRoot)"

        python3.9 --version

        # Build-time venv (for lint/tests if you add them)
        rm -rf .venv
        python3.9 -m venv .venv
        source .venv/bin/activate

        python -m pip install --upgrade pip
        python -m pip install -r requirements.txt

        # OPTIONAL: add lint/tests here
        # python -m pytest

        # IMPORTANT: do NOT ship venv in artifact
        deactivate || true
        rm -rf .venv

        echo "OK: venv removed before packaging"
      workingDirectory: $(projectRoot)
      displayName: "Build: install deps (optional) and remove venv before packaging"

    - task: ArchiveFiles@2
      displayName: "Build: archive source as tar"
      inputs:
        rootFolderOrFile: "$(projectRoot)"
        includeRootFolder: false
        archiveType: tar
        archiveFile: "$(Build.ArtifactStagingDirectory)/$(Build.BuildId).tar"
        replaceExistingArchive: true

    - upload: "$(Build.ArtifactStagingDirectory)/$(Build.BuildId).tar"
      displayName: "Build: upload artifact"
      artifact: drop


- stage: Deploy
  displayName: Deploy stage (local)
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: DeployJob
    pool: Naveen-LinuxVM
    steps:
    - checkout: none

    - download: current
      artifact: drop
      displayName: "Deploy: download artifact"

    - script: |
        set -euo pipefail

        TAR_FILE="$(Pipeline.Workspace)/drop/$(Build.BuildId).tar"
        DEPLOY_DIR="$(deployRoot)"

        echo "Tar: $TAR_FILE"
        echo "Deploy dir: $DEPLOY_DIR"

        mkdir -p "$DEPLOY_DIR"

        # Extract over the deploy dir (overlay)
        tar -xf "$TAR_FILE" -C "$DEPLOY_DIR"

        cd "$DEPLOY_DIR"

        # Create venv fresh in the deploy directory (prevents 'bad interpreter' fiasco)
        rm -rf .venv
        python3.9 -m venv .venv
        source .venv/bin/activate
        python -m pip install --upgrade pip
        python -m pip install -r requirements.txt

        # Restart Flask (manual-process style)
        pkill -f "flask --app app run --host 0.0.0.0 --port 5000" || true
        nohup flask --app app run --host 0.0.0.0 --port 5000 > flask.out 2>&1 &

        sleep 2
        curl -fsS http://127.0.0.1:5000/ | head

        echo "Deployed and running from: $DEPLOY_DIR"
        echo "Logs: $DEPLOY_DIR/flask.out"
      displayName: "Deploy: extract tar, create venv, install deps, restart Flask, smoke test"
