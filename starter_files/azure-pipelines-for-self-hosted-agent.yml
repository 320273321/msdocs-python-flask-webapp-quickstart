trigger:
- master

pool: Naveen-LinuxVM

variables:
  projectRoot: $(System.DefaultWorkingDirectory)
  deployRoot: /home/320273321/deploy/flaskapp

stages:
- stage: Build
  displayName: Build stage
  jobs:
  - job: BuildJob
    pool: Naveen-LinuxVM
    steps:



    - script: |
        set -euo pipefail
        cd "$(projectRoot)"

        python3.9 --version

        # Build-time venv (for lint/tests if you add them)
        rm -rf .venv
        python3.9 -m venv .venv
        source .venv/bin/activate

        python -m pip install --upgrade pip
        python -m pip install -r requirements.txt

        # OPTIONAL: add lint/tests here
        # python -m pytest

        # IMPORTANT: do NOT ship venv in artifact
        deactivate || true
        rm -rf .venv

        echo "OK: venv removed before packaging"
      workingDirectory: $(projectRoot)
      displayName: "Build: install deps (optional) and remove venv before packaging"

    - task: ArchiveFiles@2
      displayName: "Build: archive source as tar"
      inputs:
        rootFolderOrFile: "$(projectRoot)"
        includeRootFolder: false
        archiveType: tar
        archiveFile: "$(Build.ArtifactStagingDirectory)/$(Build.BuildId).tar"
        replaceExistingArchive: true

    - upload: "$(Build.ArtifactStagingDirectory)/$(Build.BuildId).tar"
      displayName: "Build: upload artifact"
      artifact: drop


- stage: Deploy
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: DeployLocal
    pool: Naveen-LinuxVM
    steps:
    - checkout: none
    - download: current
      artifact: drop

    - script: |
        set -euo pipefail
        DEPLOY_DIR="/home/320273321/deploy/flaskapp"
        TAR_FILE="$(Pipeline.Workspace)/drop/$(Build.BuildId).tar"
        mkdir -p "$DEPLOY_DIR"
        tar -xf "$TAR_FILE" -C "$DEPLOY_DIR"
      displayName: "Deploy files"

    - script: |
        set -euo pipefail
        /home/320273321/deploy/flaskapp/run.sh
      displayName: "Restart app"

